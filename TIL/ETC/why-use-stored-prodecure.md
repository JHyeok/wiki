# 올바른 저장 프로시저의 사용법

- 네이버 D2 - 백엔드 개발자를 꿈꾸는 학생개발자에게

Stored prodecure도 가급적 사용하지 않는 경우가 많습니다.

DB안에서 실행되는 Stored procedure는 급하게 개발된 서비스에서는 많이 사용되었습니다.

네트워크 호출비용이 없어서 성능에 이득이 있고, DB안에 저장되니 배포절차가 단순했기 때문입니다.

그러나 길게 작성된 Stored prodecure는 만들었던 사람도 수정하기 힘든 경우가 많습니다.
데이터와 독립적으로 로직을 테스트하기도 어렵습니다. 별다른 배포절차가 없으니 버전관리가 제대로 되지 않는 경우가 많았습니다.

그리고 데이터의 연산에 DB서버의 CPU 자원을 소모함으로서 서비스가 커가면서 DB에 병목이 될수 있는 가능성을 더 키울 수 있습니다.

이런 이유로 초기에 Stored procedure로 개발했던 로직을 어플리케이션 단으로 빼는 작업이 서비스가 성장하는 과정에서 흔하게 일어납니다.

---

- 우아한 형제들 기술블로그 - 우아한형제들의 Baby Steps

가끔 회사 외부 분들을 만나서 대화를 나누다 보면, 배달의민족은 어떤 언어를 이용하여 구현했냐는 질문을 받는데요.

크게 보면 대부분의 서비스 로직이 MS SQL Server라는 DBMS의 Stored Procedure로 구성이 되어 있고, API 요청을 받는 쪽은 PHP로 구현이 되어 있었습니다.

DBMS에 모든 부하가 몰리는 구조이기 때문에 서비스 요청이 많아지면서 특정 요청에
대한 처리가 잘못되면 DBMS 부하로 장애가 나타나는 현상이 많았습니다.

근본적인 해결책은 DBMS에 있는 서비스 로직을 Application 서버 단에서 처리하는 것이고,
어떤 프로그래밍 언어를 쓸까 고민하다가 Java를 선택하게 되었습니다.

(왜 Java를 선택했는지에 대해서는 나중에 다른 글에서 말씀 드리지요)

---

- [저장 프로 시저의 단점](https://dusted.codes/drawbacks-of-stored-procedures)

현대 시대에는 이것이 더 이상 공통된 접근법이 아닙니다. 저장 프로 시저에 비즈니스 논리를 두는 일은 웹 프로그래밍 초기에 공통적 인 일이었습니다. 대안을 사용하는 경우가 거의없고 사용하기가 어려웠 기 때문입니다. 오늘 나는 그것을 반대하는 것이 좋습니다.

나는 2012 년에 스토어드 프로 시저의 비즈니스 논리에 관해서 아무것도 말하지 않을 것입니다. 스토어드 프로 시저에서는 프로와 단점에 무게를 쓴 후 다른 접근법을 능가하는 선택이 정당화 될 수 있습니다. 모든 PRO 점수는 최고 수준의 학업 성취도를 유지합니다.

컴파일 된 코드가 더 안정적이며 작업하기 쉽습니다. 디버깅 중이라면 C # 또는 Java를 사용하면 많은 정보를 얻을 수 있습니다.

저장 프로 시저가 너무 많은 책임을지게 될 가능성이 있으므로 책임을 1로 유지하는 것이 좋습니다.

책임의 분리가 부족하면 핵심 수업만으로 점점 더 커지고 점점 더 어려워지는 응용 프로그램으로 이어질 것입니다.

Entity Framework Code First와 결합 된 Microsoft Asp.Net MVC를 좋아한다면 빠르게 모든 응용 프로그램을 작성할 수 있으며 저장 프로 시저가 필요 없습니다.

---

#### 결론

저장프로시저를 사용할 수는 있지만, 저장프로시저 안에다가 비즈니스 로직을 두면 안된다. 또한 Entity Framework를 이용한 Bulk Insert/Update 에서는 비즈니스 로직을 사용하지 않은 채 SP를 사용하거나 원시쿼리를 사용하는 것은 괜찮은 것 같다. 그렇지 않으면 ORM을 배치를 돌리거나 For구문을 이용한 비성능적인 코드를 짜야한다.

---
#### 참고

[네이버 D2 - 백엔드 개발자를 꿈꾸는 학생개발자에게](https://d2.naver.com/news/3435170)

[우아한 형제들 기술블로그 - 우아한형제들의 Baby Steps](http://woowabros.github.io/woowabros/2016/06/30/woowabros_cto.html)

[저장 프로 시저의 단점](https://dusted.codes/drawbacks-of-stored-procedures)

